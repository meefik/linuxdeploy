#!./bin/sh
#
# Linux Deploy for Android
# (C) 2012 Anton Skshidlevsky <meefik@gmail.com>
#

[ -z "$HOME_DIR" ] && HOME_DIR="."

if [ -r "$HOME_DIR/etc/deploy.conf" ]; then
	. $HOME_DIR/etc/deploy.conf
else
	echo "Configuration file not found!"
	exit 1
fi

TERM=vt100
PATH=$PATH:/usr/bin:/bin:/usr/sbin:/sbin
export TERM PATH

case "$1" in
mount)
	echo "[PRINT_LN] Mounting partitions:"
	echo "[PRINT_WAIT] / ... "
	mnt=`mount | grep $MNT_TARGET`
	if [ -z "$mnt" ]; then
		[ ! -d "$MNT_TARGET" ] && mkdir -p $MNT_TARGET
		ext4_support=`cat /proc/filesystems | grep ext4`
		FS_TYPE="ext2"
		[ -n "$ext4_support" ] && FS_TYPE="ext4"
		mount -o rw,relatime -t $FS_TYPE $IMG_TARGET $MNT_TARGET
		if [ $? -eq 0 ]; then
			echo "[RESULT_DONE]"
		else
			echo "[RESULT_FAIL]"; exit 1
		fi
	else
		echo "[RESULT_SKIP]"
	fi
	
	echo "[PRINT_WAIT] /proc ... "
	tg=$MNT_TARGET/proc; mnt=`mount | grep $tg`
	if [ -z "$mnt" -a -d "$tg" ]; then
		mount -t proc proc $tg
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	echo "[PRINT_WAIT] /sys ... "
	tg=$MNT_TARGET/sys; mnt=`mount | grep $tg`
	if [ -z "$mnt" -a -d "$tg" ]; then
		mount -t sysfs sys $tg
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	echo "[PRINT_WAIT] /dev ... "
	tg=$MNT_TARGET/dev; mnt=`mount | grep $tg`
	if [ -z "$mnt" -a -d "$tg" ]; then
		mount -o bind /dev $tg
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	echo "[PRINT_WAIT] /dev/pts ... "
	tg=$MNT_TARGET/dev/pts; mnt=`mount | grep $tg`
	if [ -z "$mnt" -a -d "$tg" ]; then
		mount -t devpts devpts $tg
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	DISKS="$EXTERNAL_STORAGE $SECONDARY_STORAGE"
	for disk in $DISKS
	do
		echo "[PRINT_WAIT] $disk ... "
		tg=$MNT_TARGET$disk
		mtgt=`mount | grep $tg`
		msrc=`mount | grep $disk`
		if [ -z "$mtgt" -a -n "$msrc" ]; then
			[ ! -d "$tg" ] && mkdir -p $tg
			mount -o bind $disk $tg
			[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
		else
			echo "[RESULT_SKIP]"
		fi
	done
;;
umount)
	echo "[PRINT_WAIT] Release resources ... "
	(set -e
		pids=`lsof | grep $MNT_TARGET | awk '{print $2}' | uniq || true`
		[ -n "$pids" ] && kill -9 $pids
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_LN] Unmounting partitions: "
	um=0
	for i in '.*' '*'
	do
		parts=`mount | awk '{print $3}' | grep "^$MNT_TARGET/$i$" | sort -r`
		for p in $parts
		do
			pp=`echo $p | sed "s|$MNT_TARGET/*|/|g"`
			echo "[PRINT_WAIT] $pp ... "
			umount $p
			[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
			um=1
		done
	done
	[ $um -eq 0 ] && echo "[PRINT_LN] ...not mounted anything"
	
	echo "[PRINT_WAIT] Disassociating loop device ... "
	(set -e
		loop=`losetup | grep $IMG_TARGET | awk -F: '{print $1}' || true`
		[ -n "$loop" ] && losetup -d $loop
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
;;
install)
	if [ ! -e "$IMG_TARGET" ]; then
		echo "[PRINT_WAIT] Making new disk image ($IMG_SIZE MB) ... "
		(set -e
			dd if=/dev/zero of=$IMG_TARGET bs=1048576 count=$IMG_SIZE
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	fi
	echo "[PRINT_WAIT] Making file system ... "
	(set -e
		ext4_support=`cat /proc/filesystems | grep ext4`
		FS_TYPE="ext2"
		[ -n "$ext4_support" ] && FS_TYPE="ext4"
		is_loop=`losetup | grep $IMG_TARGET || true`
		is_raw=`cat /proc/mounts | grep $IMG_TARGET || true`
		[ -z "$is_loop" -a -z "$is_raw" ] && mke2fs -qF -t $FS_TYPE -O ^has_journal $IMG_TARGET
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"

	$0 mount
	if [ $? -ne 0 ]; then
		echo "[PRINT_LN] FAIL to deploy!"; exit 1
	fi

	echo "[PRINT_ALL] Installing Linux base system: "
	[ -z "$DEBOOTSTRAP_DIR" ] && DEBOOTSTRAP_DIR=$HOME_DIR/deploy/debootstrap
	export DEBOOTSTRAP_DIR
	debootstrap --no-check-gpg --arch $ARCH --foreign --include=locales,openssh-server,sudo $SUITE $MNT_TARGET $MIRROR
	if [ $? -ne 0 ]; then
		echo "[PRINT_LN] FAIL to deploy!"; exit 1
	fi
	
	$0 mount
	if [ $? -ne 0 ]; then
		echo "[PRINT_LN] FAIL to deploy!"; exit 1
	fi
	
	echo "[PRINT_ALL] Preparing Linux system (second stage): "
	unset DEBOOTSTRAP_DIR
	chroot $MNT_TARGET /debootstrap/debootstrap --second-stage
	if [ $? -ne 0 ]; then
		echo "[PRINT_LN] FAIL to deploy!"; exit 1
	fi
	
	$0 config
	if [ $? -ne 0 ]; then
		echo "[PRINT_LN] FAIL to deploy!"; exit 1
	fi
	
	is_gui=`echo $INSTALL_GUI | grep -i "^y"`
	if [ -n "$is_gui" ]; then
		echo "[PRINT_ALL] Installing additional packages: "
		(set -e
			chroot $MNT_TARGET aptitude update -yq
			chroot $MNT_TARGET aptitude install tightvncserver xfonts-base lxde gnome-themes gnome-menus --without-recommends -yq
			chroot $MNT_TARGET aptitude clean
		exit 0)
		if [ $? -ne 0 ]; then
			echo "[PRINT_LN] FAIL to deploy!"; exit 1
		fi
	fi
;;
config)
	$0 mount
	[ $? -ne 0 ] && exit 1

	echo "[PRINT_LN] Configuring Linux system: "

	echo "[PRINT_WAIT] DNS ... "
	(set -e
		echo "nameserver 8.8.8.8" > $MNT_TARGET/etc/resolv.conf
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"

	echo "[PRINT_WAIT] APT ... "
	(set -e
		echo "deb $MIRROR $SUITE main contrib non-free" > $MNT_TARGET/etc/apt/sources.list
		echo "deb-src $MIRROR $SUITE main contrib non-free" >> $MNT_TARGET/etc/apt/sources.list
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"

	echo "[PRINT_WAIT] mtab ... "
	(set -e
		#chroot $MNT_TARGET ln -sf /proc/mounts /etc/mtab
		cat /proc/mounts | grep $MNT_TARGET | sed "s|$MNT_TARGET/*|/|g" > $MNT_TARGET/etc/mtab
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"

	echo "[PRINT_WAIT] sudo ... "
	(set -e
		SUDO_STR="$USER_NAME ALL=(ALL:ALL) NOPASSWD:ALL"
		is_str=`cat $MNT_TARGET/etc/sudoers | grep "$SUDO_STR" || true`
		[ -z "$is_str" ] && echo $SUDO_STR >> $MNT_TARGET/etc/sudoers
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_WAIT] sftp-server ... "
	(set -e
		cp $HOME_DIR/deploy/openssh/$ARCH/sftp-server $MNT_TARGET/usr/lib/openssh/sftp-server-fix
		sed -i "s|^Subsystem sftp .*|Subsystem sftp /usr/lib/openssh/sftp-server-fix|g" $MNT_TARGET/etc/ssh/sshd_config
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_WAIT] locales ... "
	(set -e
		echo "en_US.UTF-8 UTF-8" > $MNT_TARGET/etc/locale.gen
		echo "ru_RU.UTF-8 UTF-8" >> $MNT_TARGET/etc/locale.gen
		if [ "$LANGUAGE" == "ru" ]; then
			echo "LANG=ru_RU.UTF-8" > $MNT_TARGET/etc/default/locale
		else
			echo "LANG=en_US.UTF-8" > $MNT_TARGET/etc/default/locale
		fi
		chroot $MNT_TARGET locale-gen
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_WAIT] timezone ... "
	(set -e
		TZ=`getprop persist.sys.timezone`
		echo $TZ > $MNT_TARGET/etc/timezone
		cp $MNT_TARGET/usr/share/zoneinfo/$TZ $MNT_TARGET/etc/localtime
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"

	echo "[PRINT_WAIT] users and groups ... "
	(set -e
		AIDS=`cat $HOME_DIR/etc/aids`
		for AID in $AIDS
		do
			XNAME=`echo $AID | awk -F':' '{print $1}'`
			XID=`echo $AID | awk -F':' '{print $2}'`
			is_str=`cat $MNT_TARGET/etc/group | grep "^$XNAME:" || true`
			[ -z "$is_str" ] && echo "$XNAME:x:$XID:$USER_NAME" >> $MNT_TARGET/etc/group
			is_str=`cat $MNT_TARGET/etc/passwd | grep "^$XNAME:" || true`
			[ -z "$is_str" ] && echo "$XNAME:x:$XID:$XID::/:/bin/false" >> $MNT_TARGET/etc/passwd	
		done
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_WAIT] \"$USER_NAME\" profile ... "
	(set -e
		MOTD="Debian GNU/Linux [running on Android via Linux Deploy]"
		USER_ID=5000
		GROUP_ID=5000
		chroot $MNT_TARGET useradd -m -s /bin/bash -U -u $USER_ID $USER_NAME || true
		chroot $MNT_TARGET sh -c "export $USER_NAME; echo \"changeme\nchangeme\" | (passwd $USER_NAME)"
		USER_HOME=`cat $MNT_TARGET/etc/passwd | grep "^$USER_NAME:" | awk -F: '{print $6}'`
		PROFILE_STR='PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin'
		is_str=`cat $MNT_TARGET$USER_HOME/.profile | grep "$PROFILE_STR" || true`
		[ -z "$is_str" ] && echo $PROFILE_STR >> $MNT_TARGET$USER_HOME/.profile
		mkdir $MNT_TARGET$USER_HOME/.vnc || true
		echo "MPTcXfgXGiY=" | base64 -d > $MNT_TARGET$USER_HOME/.vnc/passwd
		chmod 600 $MNT_TARGET$USER_HOME/.vnc/passwd
		echo "startlxde" > $MNT_TARGET$USER_HOME/.vnc/xstartup
		chmod 755 $MNT_TARGET$USER_HOME/.vnc/xstartup
		chown -R $USER_ID:$GROUP_ID $MNT_TARGET$USER_HOME/.vnc
		rm -f $MNT_TARGET/etc/motd || true
		echo $MOTD > $MNT_TARGET/etc/motd
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
;;
uninstall)
	$0 umount
	[ $? -ne 0 ] && exit 1
	
	echo "[PRINT_WAIT] Removing disk image ... "
	(set -e
		[ -f "$IMG_TARGET" ] && rm $IMG_TARGET
		[ -d "$MNT_TARGET" ] && rmdir $MNT_TARGET
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	
	echo "[PRINT_WAIT] Removing environment ... "
	(set -e
		rm -rf $HOME_DIR/deploy $HOME_DIR/etc $HOME_DIR/bin
		[ -d "$HOME_DIR" ] && rmdir $HOME_DIR
	exit 0)
	[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
;;
start)
	$0 mount
	[ $? -ne 0 ] && exit 1
	
	echo "[PRINT_LN] Starting services: "
	echo "[PRINT_WAIT] SSH ... "
	is_ssh=`echo $SSH_START | grep -i "^y"`
	if [ -n "$is_ssh" ]; then
		(set -e
			sed -i "s|^Port .*|Port $SSH_PORT|g" $MNT_TARGET/etc/ssh/sshd_config
			chroot $MNT_TARGET /etc/init.d/ssh start
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi

	echo "[PRINT_WAIT] VNC ... "	
	is_vnc=`echo $VNC_START | grep -i "^y"`
	if [ -n "$is_vnc" ]; then
		(set -e
			[ -e "$MNT_TARGET/tmp/.X$VNC_DISPLAY-lock" ] && rm $MNT_TARGET/tmp/.X$VNC_DISPLAY-lock
			[ -e "$MNT_TARGET/tmp/.X11-unix/X$VNC_DISPLAY" ] && rm $MNT_TARGET/tmp/.X11-unix/X$VNC_DISPLAY
			chroot $MNT_TARGET su - $USER_NAME -c "vncserver -depth $VNC_DEPTH -geometry $VNC_GEOMETRY :$VNC_DISPLAY"
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	if [ -n "$CUSTOM_STARTUP" ]; then
		echo "[PRINT_WAIT] $CUSTOM_STARTUP ... "
		(set -e
			chroot $MNT_TARGET "$CUSTOM_STARTUP start"
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	fi
;;
stop)
	echo "[PRINT_LN] Stopping services: "
	echo "[PRINT_WAIT] SSH ... "
	is_ssh=`echo $SSH_START | grep -i "^y"`
	if [ -n "$is_ssh" ]; then
		(set -e
			chroot $MNT_TARGET /etc/init.d/ssh stop
			sleep 1
			pkill -9 sshd || true
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi

	echo "[PRINT_WAIT] VNC ... "	
	is_vnc=`echo $VNC_START | grep -i "^y"`
	if [ -n "$is_vnc" ]; then
		(set -e
			chroot $MNT_TARGET su - $USER_NAME -c "vncserver -kill :$VNC_DISPLAY"
			sleep 1
			pkill -9 Xtightvnc || true
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	else
		echo "[RESULT_SKIP]"
	fi
	
	if [ -n "$CUSTOM_STARTUP" ]; then
		echo "[PRINT_WAIT] $CUSTOM_STARTUP ... "
		(set -e
			chroot $MNT_TARGET "$CUSTOM_STARTUP stop"
		exit 0)
		[ $? -eq 0 ] && echo "[RESULT_DONE]" || echo "[RESULT_FAIL]"
	fi
	$0 umount	
;;
*)
	echo "Usage: $0 <mount|umount|install|config|uninstall|start|stop>"
;;
esac